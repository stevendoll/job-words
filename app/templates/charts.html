{% extends 'base.html' %}

{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.5.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dc/3.0.6/dc.min.js"></script>


      <script type="text/javascript">
    var numberFormat = d3.format(".0f");

    var usChart = dc.geoChoroplethChart("#us-chart");
    var phraseChart = dc.bubbleChart("#phrase-chart");
    // var roundChart = dc.bubbleChart("#round-chart");

    // d3.json("/api/phrases").then(function (jsonData) {

    d3.json("/api/phrases").then(function (jsonData) {
        
        var records = jsonData["phrases"]

          records.forEach(function(x) {
            x.meanSalary = x.meanSalary / 1000;
          });


        var data = crossfilter(records);

        var states = data.dimension(function (d) {
            return d["state"];
        });
        var stateJobsSum = states.group().reduceSum(function (d) {
            return d["meanSalary"];
        });

        var phrases = data.dimension(function (d) {
            return d["phraseText"];
        });
        var statsByPhrases = phrases.group().reduce(
                function (p, v) {
                    p.meanSalary += +v["meanSalary"];
                    p.jobs += +v["jobsCount"];
                    p.jobsOver100k += +v["jobsOver100kCount"];
                    // p.radius = Math.log(p.jobsOver100k) / Math.log(1.00001);
                    p.radius = p.jobsOver100k;
                    if (p.radius > 100000) p.radius = 100000 + Math.log(p.jobsOver100k);
                    ++p.count;
                    return p;
                },
                function (p, v) {
                    p.meanSalary -= +v["meanSalary"];
                    if (p.meanSalary < 0.001) p.meanSalary = 0; // do some clean up
                    p.jobs -= +v["jobsCount"];
                    p.jobsOver100k -= +v["jobsOver100kCount"];
                    p.radius = p.jobsOver100k;
                    if (p.radius > 100000) p.radius = 100000 + Math.log(p.jobsOver100k);
                    --p.count;
                    return p;
                },
                function () {
                    return {meanSalary: 0, jobs: 0, jobsOver100k:0, count: 0, radius: 0}
                }
        );

        // var rounds = data.dimension(function (d) {
        //     return d["RoundClassDescr"];
        // });
        // var statsByRounds = rounds.group().reduce(
        //         function (p, v) {
        //             p.meanSalary += +v["Raised"];
        //             p.jobs += +v["Jobs"];
        //             return p;
        //         },
        //         function (p, v) {
        //             p.meanSalary -= +v["Raised"];
        //             if (p.meanSalary < 0.001) p.meanSalary = 0; // do some clean up
        //             p.jobs -= +v["Jobs"];
        //             return p;
        //         },
        //         function () {
        //             return {meanSalary: 0, jobs: 0}
        //         }
        // );

        d3.json("/static/js/us-states.json").then(function (statesJson) {
            usChart.width(990)
                    .height(500)
                    .dimension(states)
                    .group(stateJobsSum)
                    .colors(d3.scaleQuantize().range(["#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
                    .colorDomain([0, 200])
                    .colorCalculator(function (d) { return d ? usChart.colors()(d) : '#ccc'; })
                    .overlayGeoJson(statesJson.features, "state", function (d) {
                        return d.properties.name;
                    })
                .projection(d3.geoAlbersUsa())
                .valueAccessor(function(kv) {
                    console.log(kv);
                    return kv.value;
                })
                    .title(function (d) {
                        return "State: " + d.key + "\nTotal Amount Raised: " + numberFormat(d.value ? d.value : 0) + "M";
                    });

            phraseChart.width(990)
                    .height(500)
                    .margins({top: 10, right: 50, bottom: 30, left: 60})
                    .dimension(phrases)
                    .group(statsByPhrases)
                    .colors(d3.scaleOrdinal(d3.schemeCategory10))
                    .keyAccessor(function (p) {
                        // return p.value.meanSalary;
                        return p.value.count > 0 ? p.value.meanSalary / p.value.count : 0;
                    })
                    .valueAccessor(function (p) {
                        return p.value.jobs;
                        // return p.value.count > 0 ? p.value.jobs / p.value.count : 0;
                    })
                    .radiusValueAccessor(function (p) {
                        return p.value.radius;
                    })
                    .y(d3.scaleLog().domain([0, 1000]))
                    .x(d3.scaleLinear().domain([0, 200]))
                    .r(d3.scaleLinear().domain([0, 200000]))
                    .minRadiusWithLabel(5)
                    .elasticY(true)
                    // .yAxisPadding(100)
                    .elasticX(true)
                    .xAxisPadding(5)
                    .maxBubbleRelativeSize(0.07)
                    .renderHorizontalGridLines(true)
                    .renderVerticalGridLines(true)
                    .renderLabel(true)
                    .renderTitle(true)
                    .title(function (p) {
                        return p.key
                                + "\n"
                                + "Average Salary: " + numberFormat(p.value.count > 0 ? p.value.meanSalary / p.value.count : 0) + "k\n"
                                + "Number of Jobs: " + numberFormat(p.value.jobs) + "\n"
                                + "Jobs over $100k: " + numberFormat(p.value.jobsOver100k) + "\n"
                                + "radius: " + numberFormat(p.value.radius);
                    });
            phraseChart.yAxis().tickFormat(function (s) {
                return s + " jobs";
            });
            phraseChart.xAxis().tickFormat(function (s) {
                return s + "k";
            });

            // roundChart.width(990)
            //         .height(200)
            //         .margins({top: 10, right: 50, bottom: 30, left: 60})
            //         .dimension(rounds)
            //         .group(statsByRounds)
            //         .colors(d3.scaleOrdinal(d3.schemeCategory10))
            //         .keyAccessor(function (p) {
            //             return p.value.meanSalary;
            //         })
            //         .valueAccessor(function (p) {
            //             return p.value.jobs;
            //         })
            //         .radiusValueAccessor(function (p) {
            //             return p.value.meanSalary;
            //         })
            //         .x(d3.scaleLinear().domain([0, 5000]))
            //         .r(d3.scaleLinear().domain([0, 9000]))
            //         .minRadiusWithLabel(15)
            //         .elasticY(true)
            //         .yAxisPadding(150)
            //         .elasticX(true)
            //         .xAxisPadding(300)
            //         .maxBubbleRelativeSize(0.07)
            //         .renderHorizontalGridLines(true)
            //         .renderVerticalGridLines(true)
            //         .renderLabel(true)
            //         .renderTitle(true)
            //         .title(function (p) {
            //             return p.key
            //                     + "\n"
            //                     + "Amount Raised: " + numberFormat(p.value.meanSalary) + "M\n"
            //                     + "Number of Jobs: " + numberFormat(p.value.jobs);
            //         });
            // roundChart.yAxis().tickFormat(function (s) {
            //     return s + " jobs";
            // });
            // roundChart.xAxis().tickFormat(function (s) {
            //     return s + "M";
            // });

            dc.renderAll();
        });
    });
</script>
{{super()}}
{% endblock %}

{% block app_content %}

        {% if current_user.is_anonymous %}
        	<h1>Job market by search phrase</h1>
        {% else %}
			<h1>Hi, {{ current_user.username }}!</h1>
        {% endif %}

    <div id="phrase-chart">
        <strong>By Phrases</strong> (y: number of jobs, x: average salary, radius: number of jobs over $100k)
        <a class="reset" href="javascript:phraseChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>

        <div class="clearfix"></div>
    </div>

    <div class="clearfix"></div>

    <!-- <div id="us-chart">
        <strong>Job Distribution by States (color: total number of jobs)</strong>
        <a class="reset" href="javascript:usChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        <span class="reset" style="display: none;"> | Current filter: <span class="filter"></span></span>

        <div class="clearfix"></div>
    </div> -->

    <div class="clearfix"></div>

    <!-- <div id="round-chart">
        <strong>By Rounds</strong> (y: number of jobs, x: total amount raised in millions, radius: amount raised)
        <a class="reset" href="javascript:roundChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>

        <div class="clearfix"></div>
    </div> -->

    <div class="clearfix"></div>

    <div>
        <a href="javascript:dc.filterAll(); dc.renderAll();">Reset All</a>
    </div>

{% endblock %}